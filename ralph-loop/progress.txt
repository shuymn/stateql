## Codebase Patterns
- For recursive IR expression trees, keep payload recursion explicit with `Box<Expr>` and isolate shared query/window payloads (`SubQuery`, `WindowSpec`) in a dedicated `ir/expr.rs` module, then re-export through `ir.rs` and `lib.rs` to stabilize downstream imports.
- For IR enums that must keep `Value::Float(f64)`, use `PartialEq` for the base type and provide a dedicated `f64::total_cmp`-based helper (for Eq-like paths) instead of introducing `ordered-float`.
- For RAII transaction contracts, centralize `COMMIT`/`ROLLBACK` behavior inside `stateql_core::Transaction` and keep adapter implementations focused on connection-specific `execute`/`begin` plumbing.
- For trait-contract expansion tasks, lock the required method set with a dedicated core integration test (`crates/core/tests/*_contract_test.rs`) that calls each trait method, then update every dialect crate in the same change so `cargo check --workspace` stays green.
- Keep shared cross-crate contract types in a dedicated `src/*.rs` module and re-export them from `lib.rs` so integration tests and downstream crates can use stable root paths.
- Task boundary tests live under `crates/core/tests/` and can enforce source-level boundaries by reading `src/*.rs` via `env!("CARGO_MANIFEST_DIR")`.
- Keep early-phase core placeholders as minimal re-exported stubs in `crates/core/src/lib.rs` so downstream dialect crates continue compiling.
- For early contract tasks, `#[path = "../src/*.rs"]` tests in `crates/core/tests/` are useful to lock internal type shapes before public re-exports are finalized.
- Promote stage errors through a single `stateql_core::Error` + `stateql_core::Result<T>` boundary, then propagate that alias through core traits and dialect stubs to keep signatures consistent.

---

## 2026-02-22 - task-0: Remove Bootstrap Placeholders
- What was implemented: Removed bootstrap placeholders (`plan_diff`, smoke test, and legacy diff variants) and kept Task 0 stubs (`CoreError/CoreResult`, `Ident`, `SchemaObject`, `DiffOp`, `Statement`, `Dialect`) as compile boundaries.
- Files changed: `crates/core/src/lib.rs`, `crates/core/src/ir.rs`, `crates/core/src/diff.rs`, `crates/core/tests/bootstrap_boundary_test.rs`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test bootstrap_boundary_test`: PASS (2 passed, 0 failed).
  - `rg -n "plan_diff|CreateObject|DropObject|smoke_parse_diff_render" crates/core -S`: no matches.
  - `cargo check -p stateql-core`: PASS.
  - Public Task 0 error boundary (`CoreError/CoreResult`) verified in `bootstrap_boundary_test`.
- **Learnings:**
  - Patterns discovered: Use integration tests to pin "removed symbol" boundaries with file-content assertions while avoiding hard-coded legacy tokens in source.
  - Gotchas encountered: `.git` is read-only in this sandbox (`index.lock` cannot be created), so `git add`/`git commit` cannot run here.
---

## 2026-02-22 - task-1: Add Stage-Typed Error Enums
- What was implemented: Added stage-typed errors (`ParseError`, `DiffError`, `GenerateError`, `ExecutionError`) and `SourceLocation`, plus RED->GREEN tests that assert typed variants and parse context retention on `ParseError::StatementConversion`.
- Files changed: `crates/core/src/error.rs`, `crates/core/tests/error_types_test.rs`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test error_types_test`: PASS (2 passed, 0 failed).
  - `ParseError::StatementConversion` statement context + `SourceLocation` retention: PASS in `parse_error_statement_conversion_keeps_statement_context_and_location`.
- **Learnings:**
  - Patterns discovered: Boundary-phase error contracts can be pinned with integration tests that include source modules directly while public exports are still in flux.
  - Gotchas encountered: `thiserror` download failed in this sandbox (`index.crates.io` DNS resolution error), so manual `Display`/`Error` impls were used; `git commit` still fails because `.git/index.lock` cannot be created.
---

## 2026-02-22 - task-2: Add Top-Level Error and Result<T>
- What was implemented: Added top-level `Error` (`Parse`, `Diff`, `Generate`, `Execute`) with `From` conversions and `Result<T>` alias in core; exported the typed errors and alias via `stateql_core`; added RED->GREEN wrapper tests; refactored core public trait signatures (`Dialect`, `DatabaseAdapter`) and all dialect stub implementations to return `Result<T>`.
- Files changed: `crates/core/src/error.rs`, `crates/core/src/lib.rs`, `crates/core/src/adapter.rs`, `crates/core/src/dialect.rs`, `crates/core/tests/error_wrap_test.rs`, `crates/core/tests/bootstrap_boundary_test.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-mysql/src/lib.rs`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-mssql/src/lib.rs`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test error_wrap_test`: PASS (2 passed, 0 failed).
  - `rg -n "fn (parse|generate_ddl|export_schema|execute).*-> Result<" crates/core/src/{dialect.rs,adapter.rs}`: PASS (core public API returns `Result<T>`).
  - Additional verification: `cargo nextest run -p stateql-core` PASS (6 passed, 0 failed), `cargo check` PASS.
- **Learnings:**
  - Patterns discovered: Wrapper-layer tests should hit public crate exports (`stateql_core::{Error, Result, ...}`) to lock both type shape and re-export boundaries in one place.
  - Gotchas encountered: commit is still blocked in this sandbox because `.git/index.lock` cannot be created (`Operation not permitted`).
---

## 2026-02-22 - task-3: Add Version and ConnectionConfig
- What was implemented: Added `Version { major, minor, patch }` and v1 `ConnectionConfig` (`host`, `port`, `user`, `password`, `database`, `socket`, `extra`) in new `config.rs`, re-exported both from `stateql_core`, and added RED->GREEN integration tests that construct and assert both types.
- Files changed: `crates/core/src/config.rs`, `crates/core/src/lib.rs`, `crates/core/tests/config_types_test.rs`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test config_types_test`: PASS (2 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Contract-foundation tasks can use constructor-by-literal tests in `crates/core/tests/` to lock field names/types before trait signatures start depending on them.
  - Gotchas encountered: commit remains blocked in this sandbox (`.git/index.lock` cannot be created), so the plan-specified commit command could not complete.
---

## 2026-02-22 - task-4: Expand Dialect Trait to Full Contract
- What was implemented: Expanded `stateql_core::Dialect` to the full v1 contract (`to_sql`, `normalize`, `equivalence_policy`, `quote_ident`, `batch_separator`, `connect`) with `name()` returning `&str`; added `EquivalencePolicy` + `DEFAULT_EQUIVALENCE_POLICY` in core; added RED->GREEN contract test; updated all dialect stubs to implement the expanded trait and return explicit stage-typed `Parse`/`Generate`/`Execute` errors for unimplemented paths.
- Files changed: `crates/core/src/dialect.rs`, `crates/core/src/lib.rs`, `crates/core/tests/dialect_contract_test.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-mysql/src/lib.rs`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-mssql/src/lib.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test dialect_contract_test`: PASS (1 passed, 0 failed).
  - `cargo check --workspace`: PASS (core + all dialect crates compile; workspace check green).
- **Learnings:**
  - Patterns discovered: Keep unimplemented dialect stub paths fail-fast by returning typed stage errors instead of placeholder success values, so later parser/generator work cannot silently pass.
  - Gotchas encountered: Plan text mentions typed errors for `normalize`, but `normalize` has no `Result` in the contract; treated as no-op and used typed errors for `to_sql`/`connect`/stub parse+generate paths.
---

## 2026-02-22 - task-5: Implement Single-Connection Adapter + RAII Transaction
- What was implemented: Finalized `DatabaseAdapter` to the v1 synchronous single-connection contract (`export_schema`, `execute(&self, &str)`, `begin`, `schema_search_path`, `server_version`) and introduced RAII `Transaction` with `execute`, `commit`, and drop-time rollback; added dedicated Task 5 RED->GREEN tests plus an in-memory reusable fake adapter test foundation based on interior mutability (`RefCell`).
- Files changed: `crates/core/src/adapter.rs`, `crates/core/src/lib.rs`, `crates/core/tests/transaction_raii_test.rs`, `crates/core/tests/adapter_sync_contract_test.rs`, `crates/core/tests/support/fake_adapter.rs`, `crates/core/tests/dialect_contract_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test transaction_raii_test`: PASS (2 passed, 0 failed).
  - `cargo nextest run -p stateql-core --test adapter_sync_contract_test`: PASS (2 passed, 0 failed).
  - `crates/core/tests/support/fake_adapter.rs`: PASS (added reusable in-memory fake with execution log, begin/commit/rollback counters, configurable schema/version/failure hooks for Task 24-30 reuse).
- **Learnings:**
  - Patterns discovered: Signature contracts that must remain sync-only can be locked with function-pointer type assertions (`fn(&T, &str) -> Result<()>`, `for<'a> fn(&'a mut T) -> Result<Transaction<'a>>`) to fail fast if async/Future leaks into core traits.
  - Gotchas encountered: A default `begin()` implementation that builds `Transaction` from `self` breaks on unsized `Self`; keep `begin` explicit in impls and expose `Transaction::new` for adapter implementers.
---

## 2026-02-22 - task-6: Add IR Foundations (`Ident`, `QualifiedName`, `Value`, `DataType`)
- What was implemented: Split `core::ir` into module roots (`ir/ident.rs`, `ir/types.rs`), added canonical foundational types (`Ident`, `QualifiedName`, `Value`, `DataType`), preserved the current Task 0-7 `SchemaObject` stub shape, added explicit float comparison helpers (`float_total_cmp`, `value_total_eq`), and added `Ident::quoted/unquoted` constructors.
- Files changed: `crates/core/src/ir.rs`, `crates/core/src/ir/ident.rs`, `crates/core/src/ir/types.rs`, `crates/core/src/lib.rs`, `crates/core/tests/ir_foundation_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test ir_foundation_test`: PASS (2 passed, 0 failed).
  - `cargo check -p stateql-dialect-postgres -p stateql-dialect-mysql -p stateql-dialect-sqlite -p stateql-dialect-mssql`: PASS.
- **Learnings:**
  - Patterns discovered: Keep `Value::Float(f64)` in canonical IR and enforce deterministic equality needs through a dedicated `total_cmp` helper, while regular IR comparisons remain `PartialEq`.
  - Gotchas encountered: `NaN` intentionally fails `PartialEq`; tests should pin both behaviors (`PartialEq` vs total-order helper) to avoid accidental equality semantics drift.
---

## 2026-02-22 - task-7: Add Expression AST Core Variants
- What was implemented: Added a new `ir/expr.rs` module with core expression AST coverage required by the plan (`Expr`, `Literal`, `BinaryOperator`, `UnaryOperator`, `ComparisonOp`, `IsTest`, `SetQuantifier`, `WindowSpec`, `SubQuery`), wired exports through `ir.rs` and `lib.rs`, and completed RED->GREEN using `expr_ast_test`.
- Files changed: `crates/core/src/ir.rs`, `crates/core/src/ir/expr.rs`, `crates/core/src/lib.rs`, `crates/core/tests/expr_ast_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test expr_ast_test`: PASS (2 passed, 0 failed).
  - `cargo check -p stateql-dialect-postgres -p stateql-dialect-mysql -p stateql-dialect-sqlite -p stateql-dialect-mssql`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (17 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep expression variants grouped by intent (leaf/operator/range/function/compound/fallback) so future variant additions remain localized and readable.
  - Gotchas encountered: Clippy `approx_constant` (`3.14`) can fail test code under workspace-wide `-D warnings`; use `std::f64::consts::PI` in fixture literals.
---
