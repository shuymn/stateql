## Codebase Patterns
- For cross-module safety regression coverage, keep one dedicated `crates/core/tests/safety_*.rs` suite that reuses shared fake adapter/dialect fixtures and asserts both typed error payloads and side-effect counters (`begin/commit/rollback`, generated ops, executed SQL) so fail-fast/no-silent-drop guarantees stay explicit.
- For YAML online runner semantics, keep the 8-step flow explicit (`apply current -> current idempotency -> forward diff/assert/apply -> desired idempotency -> reverse diff/assert/apply -> final idempotency`) and always compute online diffs against `adapter.export_schema()` plus live `schema_search_path` so `enable_drop`/reverse behavior reflects actual database state.
- For offline YAML runner semantics, centralize `parse -> normalize -> diff -> generate` in one helper and evaluate `error` expectations outside that flow so flavor-mismatch handling can consistently treat any failure as expected.
- For YAML flavor gating in testkit, keep `matches_flavor` as a pure function and route both `run_offline_test`/`run_online_test` through one expectation wrapper so non-matching flavors enforce sqldef semantics (`Err => skip`, `Ok => fail annotation`).
- For YAML testcase schema loading, deserialize top-level `name -> TestCase` maps with `#[serde(default, deny_unknown_fields)]`, keep `enable_drop` as `Option<bool>` (tri-state), and map `serde_yaml` decode failures into core `ParseError::StatementConversion` with `SourceLocation` metadata.
- For MSSQL generator semantics, keep SQL emission in a single op dispatcher that injects `Statement::BatchBoundary` between emitted SQL statements and route `sp_rename` rendering through dedicated table/column/index helpers so batch synchronization and rename targets stay deterministic.
- For MySQL generator semantics, process contiguous table-scoped ops as a batch, merge repeated AlterColumn changes into one CHANGE COLUMN per column, emit PK ops before AUTO_INCREMENT CHANGE COLUMN rewrites, and optimize DropView+CreateView into CREATE OR REPLACE VIEW only when the target view name matches.
- For SQLite generator rebuild semantics, batch table-structure diff ops per table and emit a six-step transactional `StatementContext::SqliteTableRebuild` sequence (`CreateShadowTable` -> `CopyData` -> `DropOldTable` -> `RenameShadowTable` -> `RecreateIndexes` -> `RecreateTriggers`) so failures surface precise rebuild-step diagnostics and rollback stays atomic.
- For non-PostgreSQL residual expression equivalence, wire explicit custom `equivalence_policy()` implementations that canonicalize only `Expr::Raw` integer-cast literals + redundant outer parentheses + whitespace collapse, keep `is_equivalent_custom_type` strict, and enforce symmetry/stability with `verify_equivalence_policy_contract`.
- For MSSQL export/to_sql stability while parser conversion remains table-first, persist original `CREATE TABLE` SQL in `table.options.extra` (`mssql.source_sql`) and let `to_sql` fall back to that hint, while keeping adapter APIs synchronous with fail-fast SQL Server `2019+` version gating.
- For MySQL export/to_sql stability while parser coverage is still table-first, persist the original `CREATE TABLE` SQL in `table.options.extra` (`mysql.source_sql`) and let `to_sql` fall back to that hint, while keeping export catalog SQL centralized in `export_queries.rs` and adapter version gating fail-fast (`8.0+`).
- For SQLite export/to_sql stability while parser coverage is still table-first, persist the original `CREATE TABLE` statement in `table.options.extra` (`sqlite.source_sql`) during parse and let `to_sql` fall back to that hint when structured table fields are absent, while still returning explicit `GenerateError` for unsupported `SchemaObject` variants.
- For `sqlparser-rs` dialect parse foundations (MySQL/SQLite/MSSQL), keep the pipeline as `AnnotationExtractor::extract -> parser -> fail-fast conversion loop -> attach_annotations` and derive `statement_index`/`source_sql`/`source_location.line` from a quote/comment-aware statement splitter so non-`pg_query` backends keep deterministic parse diagnostics.
- For PostgreSQL residual expression equivalence, keep normalize() as the primary canonicalizer and scope policy matching to deterministic `Expr::Raw` spellings (casted integer literals, redundant outer parentheses, whitespace collapse), returning `false` for non-raw structural mismatches.
- For PostgreSQL adapter/export contracts, centralize catalog SQL in `export_queries.rs` and keep `connect()` fail-fast by validating `SHOW server_version` (`13+`) plus parsing `SHOW search_path` once into normalized path entries (drop `$user`/`pg_catalog`/`pg_temp*`) before diff wiring.
- For PostgreSQL normalization contracts, keep object-level normalization in `normalize_object` and cross-object canonicalization in a schema pass (`normalize_schema`) invoked from parser output so sequence/partition folding can run before core diff without changing the core `Dialect::normalize(&mut SchemaObject)` trait boundary.
- For PostgreSQL generator contracts, keep SQL emission in a single op-dispatch (`emit_op`) and centralize unsupported payload failures through `unsupported_diff_op`, with conservative `DropView + CreateView -> CREATE OR REPLACE VIEW` optimization only when compatibility is provable from payload.
- For PostgreSQL parser fail-fast behavior, derive per-statement metadata from parser spans, trim leading whitespace before computing line numbers, and route conversion failures through one wrapper (`statement_conversion_error`) so `statement_index`/`source_sql`/`source_location` stay consistent.
- For export idempotency checks, keep the orchestrator’s export pipeline as a reusable helper (`export_sql_from_input`) plus a comparison helper (`export_roundtrip_matches`) so round-trip verification logic stays aligned with runtime export rendering.
- For orchestrator export mode, branch on `Mode` before diff generation and keep `--export` on a dedicated `export_schema -> parse -> normalize -> to_sql` path so desired SQL parsing and diff/executor paths are never touched.
- For orchestrator dry-run wiring, keep `DiffEngine::diff_with_diagnostics(...)` as the single diff entrypoint and convert `DiffDiagnostics.skipped_ops` into renderer comment lines (`-- Skipped: <kind>`) before appending statement rendering so suppression visibility stays consistent.
- For dry-run statement rendering, keep `Renderer` as the single statement-to-text boundary: emit each SQL statement with a trailing newline, map `Statement::BatchBoundary` through `Dialect::batch_separator()`, and normalize separator newlines so dialects can return either `GO` or `GO\n` safely.
- For executor failure diagnostics, map adapter and transaction errors through a shared statement-error builder that merges current statement metadata with inherited execution location/context, and box statement_context in ExecutionError to avoid clippy result_large_err regressions.
- For executor `BatchBoundary` semantics, treat `Statement::BatchBoundary` as a cursor-advance no-op both inside transactional scans and top-level dispatch so `T,T,B,T` stays in one transaction while preserving sync-point ordering.
- For executor `transactional:false` boundaries, keep transactional runs as contiguous groups (`T*`) and execute non-transactional SQL directly between groups, with a shared `flush_tx_if_open` commit helper so boundary behavior stays explicit ahead of `BatchBoundary` tasking.
- For executor transaction grouping, scan `Statement` slices into contiguous transactional runs and execute each run through a single RAII `Transaction`, while keeping unsupported statement kinds as explicit fail-fast branches until their dedicated tasks land.
- For circular FK fallback, preprocess dependency graphs in `crates/core/src/diff/cycle.rs` so only cycle-forming FK edges are split into `AddForeignKey`/`DropForeignKey` ops, while self-referential FKs stay embedded on `CreateTable`.
- For DDL planning boundaries, keep `DdlPlanner`/`DdlPlan` in `crates/core/src/plan.rs` and route `DiffEngine` ordering through `build_ddl_plan(...)` so ordering rules stay single-sourced in Task 22 sorter logic.
- For deterministic diff ordering, centralize sort logic in `crates/core/src/ordering.rs` with explicit priority/sub-priority enums and apply dependency topological sorting only inside the relevant priority groups (`CreateTable`, `CreateView`), while preserving original declaration order as the fallback tie-breaker.
- For view rebuild closure, derive changed-view dependents from the current schema graph and emit `DropView` in reverse topological order plus `CreateView` in desired topological order, so unchanged dependent views are rebuilt deterministically.
- For privilege diff semantics, match entries by `(on, grantee)` and compute operation deltas through a canonical helper (`diff_privilege_ops`) so list ordering/duplicates do not affect emitted minimal `Grant/Revoke` changes.
- For constraint-modification exceptions under `enable_drop=false`, emit matched drop+add pairs from compare logic via a shared constraint-key helper so general suppression/diagnostics flow remains unchanged for truly destructive drops.
- For `enable_drop` diagnostics, keep current diff emission logic as the source of truth and derive skipped destructive diagnostics by comparing an `enable_drop=true` pass with emitted ops through a centralized `SkippedOpKind` table, so future exceptions (like paired drops) can remain emitted without breaking diagnostics accounting.
- For `schema_search_path` support in diff matching, keep strict key lookup first and run a dedicated fallback resolver only on misses so qualified/unqualified matching stays deterministic (first search-path schema wins) without interfering with rename resolution.
- For rename-aware diffing, keep strict name matching as the default path and run `resolve_rename_match(...)` only for unmatched desired objects so annotated renames emit `Rename*` ops without reintroducing drop/create churn.
- For partition diffing in `DiffEngine`, delegate table partition logic to a dedicated `diff::partition` module and perform a two-stage compare (partition key: strategy+columns, then partition elements) so add/drop/change decomposition stays isolated from column/check comparison code.
- For expanding `SchemaObject` diff coverage incrementally, keep `match SchemaObject` paths exhaustive (no wildcard arms) and route not-yet-supported variants through explicit `DiffError` fail-fast checks.
- For staged diff-engine development, keep `DiffEngine::diff` split into explicit phases (`compare_*` first, then a dedicated resolve/order hook) so name resolution and ordering tasks can evolve without coupling to object-diff logic.
- For injected semantic-equivalence hooks, keep strict equality as the first-stage gate via a shared fallback helper (`strict_or_policy`) and enforce policy purity assumptions with a reusable contract validator (symmetry + repeated-call stability checks).
- For dialect-specific `Column.extra` metadata, define key constants in core (`stateql_core::extra_keys::<dialect>::*`) and consume those constants in fixtures/tests to prevent parser/generator key drift before dialect implementations land.
- For wide contract enums under workspace `-D warnings`, pair an exhaustive variant-tag `match` helper with an `all_*_variants()` fixture list; this catches new-variant drift at compile time, and if `clippy::large_enum_variant` fires, box only the largest payload field instead of suppressing the lint.
- For fail-fast rename annotation attachment, first resolve every line->target binding into immutable operations, then mutate IR objects in a second pass so orphan annotations cannot partially set `renamed_from`.
- For comment-driven SQL metadata (for example `@renamed`), run a quote-aware line-comment scan and strip only the matched annotation token so cleaned SQL keeps original line boundaries for parser error mapping.
- When extending shared enum payloads (for example `Statement::Sql`), update the core enum, root re-exports, and all contract-test constructors in one task so workspace-wide quality gates catch no stale struct literals.
- For multi-phase IR growth, add new object-family structs/enums in one module pass and update both `ir.rs` and `lib.rs` re-exports in the same change so downstream crate imports never drift during task boundaries.
- For staged IR expansion, move growing object families into `src/ir/<domain>.rs` and switch enum variants to typed payload structs in one change, then immediately update cross-crate fixture constructors to keep workspace-wide tests green.
- For recursive IR expression trees, keep payload recursion explicit with `Box<Expr>` and isolate shared query/window payloads (`SubQuery`, `WindowSpec`) in a dedicated `ir/expr.rs` module, then re-export through `ir.rs` and `lib.rs` to stabilize downstream imports.
- For IR enums that must keep `Value::Float(f64)`, use `PartialEq` for the base type and provide a dedicated `f64::total_cmp`-based helper (for Eq-like paths) instead of introducing `ordered-float`.
- For RAII transaction contracts, centralize `COMMIT`/`ROLLBACK` behavior inside `stateql_core::Transaction` and keep adapter implementations focused on connection-specific `execute`/`begin` plumbing.
- For trait-contract expansion tasks, lock the required method set with a dedicated core integration test (`crates/core/tests/*_contract_test.rs`) that calls each trait method, then update every dialect crate in the same change so `cargo check --workspace` stays green.
- Keep shared cross-crate contract types in a dedicated `src/*.rs` module and re-export them from `lib.rs` so integration tests and downstream crates can use stable root paths.
- Task boundary tests live under `crates/core/tests/` and can enforce source-level boundaries by reading `src/*.rs` via `env!("CARGO_MANIFEST_DIR")`.
- Keep early-phase core placeholders as minimal re-exported stubs in `crates/core/src/lib.rs` so downstream dialect crates continue compiling.
- For early contract tasks, `#[path = "../src/*.rs"]` tests in `crates/core/tests/` are useful to lock internal type shapes before public re-exports are finalized.
- Promote stage errors through a single `stateql_core::Error` + `stateql_core::Result<T>` boundary, then propagate that alias through core traits and dialect stubs to keep signatures consistent.

---

## 2026-02-22 - task-0: Remove Bootstrap Placeholders
- What was implemented: Removed bootstrap placeholders (`plan_diff`, smoke test, and legacy diff variants) and kept Task 0 stubs (`CoreError/CoreResult`, `Ident`, `SchemaObject`, `DiffOp`, `Statement`, `Dialect`) as compile boundaries.
- Files changed: `crates/core/src/lib.rs`, `crates/core/src/ir.rs`, `crates/core/src/diff.rs`, `crates/core/tests/bootstrap_boundary_test.rs`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test bootstrap_boundary_test`: PASS (2 passed, 0 failed).
  - `rg -n "plan_diff|CreateObject|DropObject|smoke_parse_diff_render" crates/core -S`: no matches.
  - `cargo check -p stateql-core`: PASS.
  - Public Task 0 error boundary (`CoreError/CoreResult`) verified in `bootstrap_boundary_test`.
- **Learnings:**
  - Patterns discovered: Use integration tests to pin "removed symbol" boundaries with file-content assertions while avoiding hard-coded legacy tokens in source.
  - Gotchas encountered: `.git` is read-only in this sandbox (`index.lock` cannot be created), so `git add`/`git commit` cannot run here.
---

## 2026-02-22 - task-1: Add Stage-Typed Error Enums
- What was implemented: Added stage-typed errors (`ParseError`, `DiffError`, `GenerateError`, `ExecutionError`) and `SourceLocation`, plus RED->GREEN tests that assert typed variants and parse context retention on `ParseError::StatementConversion`.
- Files changed: `crates/core/src/error.rs`, `crates/core/tests/error_types_test.rs`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test error_types_test`: PASS (2 passed, 0 failed).
  - `ParseError::StatementConversion` statement context + `SourceLocation` retention: PASS in `parse_error_statement_conversion_keeps_statement_context_and_location`.
- **Learnings:**
  - Patterns discovered: Boundary-phase error contracts can be pinned with integration tests that include source modules directly while public exports are still in flux.
  - Gotchas encountered: `thiserror` download failed in this sandbox (`index.crates.io` DNS resolution error), so manual `Display`/`Error` impls were used; `git commit` still fails because `.git/index.lock` cannot be created.
---

## 2026-02-22 - task-2: Add Top-Level Error and Result<T>
- What was implemented: Added top-level `Error` (`Parse`, `Diff`, `Generate`, `Execute`) with `From` conversions and `Result<T>` alias in core; exported the typed errors and alias via `stateql_core`; added RED->GREEN wrapper tests; refactored core public trait signatures (`Dialect`, `DatabaseAdapter`) and all dialect stub implementations to return `Result<T>`.
- Files changed: `crates/core/src/error.rs`, `crates/core/src/lib.rs`, `crates/core/src/adapter.rs`, `crates/core/src/dialect.rs`, `crates/core/tests/error_wrap_test.rs`, `crates/core/tests/bootstrap_boundary_test.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-mysql/src/lib.rs`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-mssql/src/lib.rs`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test error_wrap_test`: PASS (2 passed, 0 failed).
  - `rg -n "fn (parse|generate_ddl|export_schema|execute).*-> Result<" crates/core/src/{dialect.rs,adapter.rs}`: PASS (core public API returns `Result<T>`).
  - Additional verification: `cargo nextest run -p stateql-core` PASS (6 passed, 0 failed), `cargo check` PASS.
- **Learnings:**
  - Patterns discovered: Wrapper-layer tests should hit public crate exports (`stateql_core::{Error, Result, ...}`) to lock both type shape and re-export boundaries in one place.
  - Gotchas encountered: commit is still blocked in this sandbox because `.git/index.lock` cannot be created (`Operation not permitted`).
---

## 2026-02-22 - task-3: Add Version and ConnectionConfig
- What was implemented: Added `Version { major, minor, patch }` and v1 `ConnectionConfig` (`host`, `port`, `user`, `password`, `database`, `socket`, `extra`) in new `config.rs`, re-exported both from `stateql_core`, and added RED->GREEN integration tests that construct and assert both types.
- Files changed: `crates/core/src/config.rs`, `crates/core/src/lib.rs`, `crates/core/tests/config_types_test.rs`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test config_types_test`: PASS (2 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Contract-foundation tasks can use constructor-by-literal tests in `crates/core/tests/` to lock field names/types before trait signatures start depending on them.
  - Gotchas encountered: commit remains blocked in this sandbox (`.git/index.lock` cannot be created), so the plan-specified commit command could not complete.
---

## 2026-02-22 - task-4: Expand Dialect Trait to Full Contract
- What was implemented: Expanded `stateql_core::Dialect` to the full v1 contract (`to_sql`, `normalize`, `equivalence_policy`, `quote_ident`, `batch_separator`, `connect`) with `name()` returning `&str`; added `EquivalencePolicy` + `DEFAULT_EQUIVALENCE_POLICY` in core; added RED->GREEN contract test; updated all dialect stubs to implement the expanded trait and return explicit stage-typed `Parse`/`Generate`/`Execute` errors for unimplemented paths.
- Files changed: `crates/core/src/dialect.rs`, `crates/core/src/lib.rs`, `crates/core/tests/dialect_contract_test.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-mysql/src/lib.rs`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-mssql/src/lib.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test dialect_contract_test`: PASS (1 passed, 0 failed).
  - `cargo check --workspace`: PASS (core + all dialect crates compile; workspace check green).
- **Learnings:**
  - Patterns discovered: Keep unimplemented dialect stub paths fail-fast by returning typed stage errors instead of placeholder success values, so later parser/generator work cannot silently pass.
  - Gotchas encountered: Plan text mentions typed errors for `normalize`, but `normalize` has no `Result` in the contract; treated as no-op and used typed errors for `to_sql`/`connect`/stub parse+generate paths.
---

## 2026-02-22 - task-5: Implement Single-Connection Adapter + RAII Transaction
- What was implemented: Finalized `DatabaseAdapter` to the v1 synchronous single-connection contract (`export_schema`, `execute(&self, &str)`, `begin`, `schema_search_path`, `server_version`) and introduced RAII `Transaction` with `execute`, `commit`, and drop-time rollback; added dedicated Task 5 RED->GREEN tests plus an in-memory reusable fake adapter test foundation based on interior mutability (`RefCell`).
- Files changed: `crates/core/src/adapter.rs`, `crates/core/src/lib.rs`, `crates/core/tests/transaction_raii_test.rs`, `crates/core/tests/adapter_sync_contract_test.rs`, `crates/core/tests/support/fake_adapter.rs`, `crates/core/tests/dialect_contract_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test transaction_raii_test`: PASS (2 passed, 0 failed).
  - `cargo nextest run -p stateql-core --test adapter_sync_contract_test`: PASS (2 passed, 0 failed).
  - `crates/core/tests/support/fake_adapter.rs`: PASS (added reusable in-memory fake with execution log, begin/commit/rollback counters, configurable schema/version/failure hooks for Task 24-30 reuse).
- **Learnings:**
  - Patterns discovered: Signature contracts that must remain sync-only can be locked with function-pointer type assertions (`fn(&T, &str) -> Result<()>`, `for<'a> fn(&'a mut T) -> Result<Transaction<'a>>`) to fail fast if async/Future leaks into core traits.
  - Gotchas encountered: A default `begin()` implementation that builds `Transaction` from `self` breaks on unsized `Self`; keep `begin` explicit in impls and expose `Transaction::new` for adapter implementers.
---

## 2026-02-22 - task-6: Add IR Foundations (`Ident`, `QualifiedName`, `Value`, `DataType`)
- What was implemented: Split `core::ir` into module roots (`ir/ident.rs`, `ir/types.rs`), added canonical foundational types (`Ident`, `QualifiedName`, `Value`, `DataType`), preserved the current Task 0-7 `SchemaObject` stub shape, added explicit float comparison helpers (`float_total_cmp`, `value_total_eq`), and added `Ident::quoted/unquoted` constructors.
- Files changed: `crates/core/src/ir.rs`, `crates/core/src/ir/ident.rs`, `crates/core/src/ir/types.rs`, `crates/core/src/lib.rs`, `crates/core/tests/ir_foundation_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test ir_foundation_test`: PASS (2 passed, 0 failed).
  - `cargo check -p stateql-dialect-postgres -p stateql-dialect-mysql -p stateql-dialect-sqlite -p stateql-dialect-mssql`: PASS.
- **Learnings:**
  - Patterns discovered: Keep `Value::Float(f64)` in canonical IR and enforce deterministic equality needs through a dedicated `total_cmp` helper, while regular IR comparisons remain `PartialEq`.
  - Gotchas encountered: `NaN` intentionally fails `PartialEq`; tests should pin both behaviors (`PartialEq` vs total-order helper) to avoid accidental equality semantics drift.
---

## 2026-02-22 - task-7: Add Expression AST Core Variants
- What was implemented: Added a new `ir/expr.rs` module with core expression AST coverage required by the plan (`Expr`, `Literal`, `BinaryOperator`, `UnaryOperator`, `ComparisonOp`, `IsTest`, `SetQuantifier`, `WindowSpec`, `SubQuery`), wired exports through `ir.rs` and `lib.rs`, and completed RED->GREEN using `expr_ast_test`.
- Files changed: `crates/core/src/ir.rs`, `crates/core/src/ir/expr.rs`, `crates/core/src/lib.rs`, `crates/core/tests/expr_ast_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test expr_ast_test`: PASS (2 passed, 0 failed).
  - `cargo check -p stateql-dialect-postgres -p stateql-dialect-mysql -p stateql-dialect-sqlite -p stateql-dialect-mssql`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (17 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep expression variants grouped by intent (leaf/operator/range/function/compound/fallback) so future variant additions remain localized and readable.
  - Gotchas encountered: Clippy `approx_constant` (`3.14`) can fail test code under workspace-wide `-D warnings`; use `std::f64::consts::PI` in fixture literals.
---

## 2026-02-22 - task-8: Add Full `SchemaObject` Family (Part 1)
- What was implemented: Added a dedicated `ir/schema_object.rs` module and replaced the temporary `SchemaObject` stub with typed top-level variants (`Table`, `View`, `MaterializedView`, `Index`, `Sequence`), plus part-1 IR structs/enums (`Column`, `Identity`, `GeneratedColumn`, `PrimaryKey`, `TableOptions`, `IndexDef`, `IndexColumn`, `IndexOwner`, `Partition`, `PartitionStrategy`, `PartitionElement`, `PartitionBound`, `Sequence`, `ColumnPosition`) and constructors (`Table::named`, `View::new`); updated existing fixtures/tests that still used the old struct-style `SchemaObject::Table` variant shape.
- Files changed: `crates/core/src/ir.rs`, `crates/core/src/ir/schema_object.rs`, `crates/core/src/lib.rs`, `crates/core/tests/schema_object_part1_test.rs`, `crates/core/tests/dialect_contract_test.rs`, `crates/testkit/src/lib.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test schema_object_part1_test`: PASS (2 passed, 0 failed).
  - `cargo check -p stateql-dialect-postgres -p stateql-dialect-mysql -p stateql-dialect-sqlite -p stateql-dialect-mssql`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (19 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: When promoting placeholder enum variants to typed payload structs, keep constructor helpers (`Table::named`, `View::new`) in the same module so downstream fixtures can migrate with minimal noise.
  - Gotchas encountered: Legacy fixtures in non-core crates (`testkit`) can still rely on old variant constructor shape even if core unit tests pass; include a workspace-wide run before marking the task done.
---

## 2026-02-22 - task-9: Add Full `SchemaObject` Family (Part 2)
- What was implemented: Expanded `SchemaObject` to the full part-2 family (`Trigger`, `Function`, `Type`, `Domain`, `Extension`, `Schema`, `Comment`, `Privilege`, `Policy`), added all plan-required support types (`CheckConstraint`, `ExclusionConstraint`, `ExclusionElement`, `Deferrable`, `SortOrder`, `NullsOrder`, `ForeignKey`, `ForeignKeyAction`, `CheckOption`, `ViewSecurity`, `TriggerTiming`, `TriggerEvent`, `TriggerForEach`, `FunctionParam`, `FunctionParamMode`, `Volatility`, `FunctionSecurity`, `PrivilegeOp`, `PrivilegeObject`, `PolicyCommand`, `TypeKind`, `EnumValuePosition`, `CommentTarget`), added `Privilege::empty`, and aligned existing IR structs (`Table`, `View`, `MaterializedView`) plus crate re-exports to the expanded contract.
- Files changed: `crates/core/src/ir.rs`, `crates/core/src/ir/schema_object.rs`, `crates/core/src/lib.rs`, `crates/core/tests/schema_object_part1_test.rs`, `crates/core/tests/schema_object_part2_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test schema_object_part2_test`: PASS (2 passed, 0 failed).
  - `cargo check -p stateql-dialect-postgres -p stateql-dialect-mysql -p stateql-dialect-sqlite -p stateql-dialect-mssql`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (21 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: When adding large IR type families, constructor-focused integration tests (`schema_object_part*_test`) catch re-export and struct-shape regressions earlier than downstream crate checks.
  - Gotchas encountered: Workspace-wide clippy flags even test-only style nits (`redundant_pattern_matching`), so the quality-gate run should happen before updating tracking artifacts.
---

## 2026-02-22 - task-10: Add Statement Context Model
- What was implemented: Added statement execution context modeling to core statements by extending `Statement::Sql` with `context: Option<StatementContext>`, introducing `StatementContext::SqliteTableRebuild { table, step }` and `SqliteRebuildStep` variants, re-exporting both new types from `stateql_core`, and adding a RED->GREEN integration test that validates SQLite rebuild context retention on generated statements.
- Files changed: `crates/core/src/statement.rs`, `crates/core/src/lib.rs`, `crates/core/tests/statement_context_test.rs`, `crates/core/tests/dialect_contract_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test statement_context_test`: PASS (1 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (22 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Statement-level diagnostic metadata should be modeled as typed enums on `Statement::Sql` and propagated via `Option` so execution semantics remain unchanged while diagnostics gain structure.
- Gotchas encountered: Adding a field to shared enum variants requires immediate updates to existing contract fixtures (`Statement::Sql` constructors) or workspace-wide compilation will fail before task tests run.
---

## 2026-02-22 - task-11: Add Annotation Extractor (`@renamed`)
- What was implemented: Added core annotation extraction via `AnnotationExtractor::extract` with line-preserving SQL cleanup, comment-only `@renamed from=...` parsing, string-literal safety, and deprecated `@rename` alias acceptance via `RenameAnnotation.deprecated_alias`.
- Files changed: `crates/core/src/annotation.rs`, `crates/core/src/lib.rs`, `crates/core/tests/annotation_extractor_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test annotation_extractor_test`: PASS (2 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (24 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep rename annotation parsing in core with an explicit `deprecated_alias` marker so later parser pipelines can emit deprecation warnings without re-parsing comment tokens.
  - Gotchas encountered: Failing to preserve exact line count during annotation stripping would break downstream parser line mapping; line endings must remain untouched while removing only annotation substrings.
---

## 2026-02-22 - task-12: Add Annotation Attachment Validation
- What was implemented: Added `attach_annotations` in core with typed attachment targets (`AnnotationAttachment` / `AnnotationTarget`) that resolves annotation line bindings to IR object keys (`Table`, `View`, `MaterializedView`, and column variants), validates orphan/ambiguous matches as `DiffError`, and applies `renamed_from` updates only after full validation to keep fail-fast semantics.
- Files changed: `crates/core/src/annotation.rs`, `crates/core/src/lib.rs`, `crates/core/tests/annotation_attach_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test annotation_attach_test`: PASS (2 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (26 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Two-phase annotation attachment (resolve first, apply second) is the safest way to enforce S2 fail-fast behavior without partial IR mutation.
  - Gotchas encountered: Attachment targets need key-level matching helpers (`QualifiedName`/`Ident`) in core so parser crates can pass line mappings without coupling to mutable IR traversal internals.
---

## 2026-02-22 - task-13: Add Full `DiffOp` and Change Enums
- What was implemented: Replaced the placeholder `DiffOp` with the full typed diff surface (`DiffOp`, `ColumnChange`, `SequenceChange`, `TypeChange`, `DomainChange`), split diff into `diff.rs` module root + `diff/types.rs` + `diff/engine.rs`, re-exported the new diff types from `stateql_core`, and added reusable `all_diffop_variants()` fixtures plus diff-surface tests.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/types.rs`, `crates/core/src/diff/engine.rs`, `crates/core/src/lib.rs`, `crates/core/tests/diffop_surface_test.rs`, `crates/core/tests/support/diffop_fixtures.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test diffop_surface_test`: PASS (3 passed, 0 failed).
  - `DiffOp` variant definitions are centralized in `crates/core/src/diff/types.rs` and separated from engine scaffolding in `crates/core/src/diff/engine.rs`: PASS.
  - `all_diffop_variants()` coverage guard exists and is enforced by exhaustive `diffop_variant_tag()` matching + count/uniqueness assertions: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (29 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Exhaustive variant-tag helpers in test fixtures are an effective compile-time guard against enum-surface drift while keeping runtime assertions straightforward.
  - Gotchas encountered: Expanding `DiffOp` triggered `clippy::large_enum_variant`; boxing only the largest payload field (`AddColumn.column`) resolved it without lint suppression.
---

## 2026-02-22 - task-13b: Add IR Validation Tests for Dialect-Specific Patterns
- What was implemented: Added dedicated IR/DiffOp representability coverage for MySQL/MSSQL dialect patterns (`CHANGE COLUMN` full redefinition, `AFTER` positioning, MSSQL named DEFAULT constraints, rename ops, MySQL `AUTO_INCREMENT` metadata), introduced reusable test fixtures, added core `extra_keys` constants, and added `is_mysql_change_column_full_redefinition(...)` helper for change-set validation.
- Files changed: `crates/core/tests/ir_dialect_pattern_validation_test.rs`, `crates/core/tests/support/ir_pattern_fixtures.rs`, `crates/core/src/ir.rs`, `crates/core/src/diff/types.rs`, `crates/core/src/diff.rs`, `crates/core/src/lib.rs`, `crates/core/tests/support/diffop_fixtures.rs`, `crates/core/tests/schema_object_part1_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test ir_dialect_pattern_validation_test`: PASS (5 passed, 0 failed).
  - CI required-set gate: PASS (`ir_dialect_pattern_validation_test` is under `crates/core/tests/`, and `.github/workflows/ci.yml` test job runs `cargo test --all-features`, so this task gate is part of required CI).
  - `cargo nextest run -p stateql-core`: PASS (34 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (34 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: For representability gates that precede parser implementation, use construction-only tests against public IR/DiffOp exports and keep reusable constructors in `crates/core/tests/support/*` so later dialect crates can import the same fixtures.
  - Gotchas encountered: If constants are introduced only in private modules, integration tests cannot consume them from `stateql_core`; they must be re-exported from `lib.rs` to keep constant usage consistent across crate boundaries.
---

## 2026-02-22 - task-14: Add `EquivalencePolicy` and `DiffConfig`
- What was implemented: Added `crates/core/src/diff/policy.rs` with full `EquivalencePolicy` contract (`is_equivalent_expr`, `is_equivalent_custom_type`), `DefaultEquivalencePolicy`, `DEFAULT_EQUIVALENCE_POLICY`, `DiffConfig` (`enable_drop`, `schema_search_path`, `Arc<dyn EquivalencePolicy>`), strict-eq fallback helpers (`exprs_equivalent`, `custom_types_equivalent`), and a reusable contract validator (`verify_equivalence_policy_contract`) that detects non-symmetric and non-stable policies; wired policy exports through `diff.rs` and `lib.rs`, and updated `Dialect` to consume the policy contract from `diff`.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/policy.rs`, `crates/core/src/dialect.rs`, `crates/core/src/lib.rs`, `crates/core/tests/equivalence_policy_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test equivalence_policy_test`: PASS (3 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (37 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Contract-check helpers are easiest to keep deterministic when they evaluate both forward/backward symmetry and repeated-call stability per case index, returning a typed violation enum for focused assertions.
  - Gotchas encountered: Moving shared contracts from `dialect.rs` into `diff` requires synchronized re-export updates in `lib.rs`; otherwise integration tests fail with unresolved root imports before behavior tests run.
---

## 2026-02-22 - task-15: Implement Core Object Comparison (Table/Column/Index Baseline)
- What was implemented: Added baseline `DiffEngine` comparison in new `diff/compare.rs` with separated phases (`compare_objects` then `resolve_and_order`), implemented table create/drop diffing, column add/drop plus `AlterColumn` change detection (`SetType`, `SetNotNull`, `SetDefault`), index add/drop diffing by `(owner, name)`, policy-aware expression comparison for column defaults and named CHECK constraints, and fail-fast S5 owner validation for top-level indexes.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/lib.rs`, `crates/core/tests/diff_core_compare_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test diff_core_compare_test`: PASS (6 passed, 0 failed).
  - `DiffEngine::diff` separation check: PASS (`compare_objects(...)` and `resolve_and_order(...)` are distinct functions in `crates/core/src/diff/compare.rs`).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (43 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Splitting baseline diff into object-kind helpers (`compare_table`, `compare_columns`, `compare_indexes`) keeps Task 17+ name resolution and Task 22 ordering work additive instead of requiring rewrites.
  - Gotchas encountered: Baseline comparison currently rejects non-table/index object kinds with `DiffError` to avoid silent omissions; Task 15b needs to expand this coverage deliberately rather than weakening fail-fast behavior.
---

## 2026-02-22 - task-15b: Implement Remaining SchemaObject Comparison
- What was implemented: Added remaining-object diff comparison coverage for `View`, `MaterializedView`, `Sequence`, `Trigger`, `Function`, `Type`, `Domain`, `Extension`, `Schema`, `Comment`, and `Policy`, kept `Privilege` as explicit fail-fast unsupported, and added pre-diff sequence duplicate invariant validation for explicit `Sequence` vs implicit identity sequence overlap on both desired/current sides.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff/compare_remaining.rs`, `crates/core/tests/diff_remaining_objects_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test diff_remaining_objects_test`: PASS (6 passed, 0 failed).
  - `SchemaObject` comparison routing uses exhaustive `match` handling in diff paths (no wildcard default for variant dispatch), preserving compile-time drift detection when enum variants change: PASS.
  - Duplicate sequence invariant violation (`Sequence` + identity implicit sequence overlap) verified for desired/current sides in `diff_remaining_objects_test`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (49 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: For staged diff growth, isolate newly added object-family comparisons into a dedicated module and call it from `DiffEngine::compare_objects` so table/index baseline logic stays stable while enabling per-kind expansion.
  - Gotchas encountered: `DropSchema` uses unqualified `QualifiedName { schema: None, name }`, so tests should not assume default schema qualification for schema-drop ops.
---
## 2026-02-22 - task-15c: Implement Partition Diff Comparison (`AddPartition` / `DropPartition`)
- What was implemented: Added explicit partition diff logic by creating `crates/core/src/diff/partition.rs` and wiring `DiffEngine` table comparison to call it; implemented partition add/drop and change decomposition (`DropPartition` + `AddPartition`) including bound-sensitive detection for `MAXVALUE` and `FromTo`.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff/partition.rs`, `crates/core/tests/partition_diff_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test partition_diff_test`: PASS (5 passed, 0 failed).
  - Table compare now delegates partition diff responsibility to `partition::diff_partition(...)`: PASS (`crates/core/src/diff/compare.rs`).
  - Task 22 (22h) ordering linkage for partition ops: PASS via explicit drop-before-add assertion on bound change in `partition_diff_test` (`treats_from_to_bound_change_as_partition_change`).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (54 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Comparing partition key (`strategy` + normalized partition columns) before element-level diffing avoids mixing table-level partition-shape changes with per-partition add/drop reconciliation.
  - Gotchas encountered: Iterating a `BTreeMap<_, &PartitionElement>` yields `&&PartitionElement`; the diff helper must clone from dereferenced values (`(*element).clone()`) to build owned `DiffOp` payloads cleanly.
---
## 2026-02-22 - task-16: Implement Rename Detection from `renamed_from`
- What was implemented: Added rename-aware matching to `DiffEngine` for tables and columns using `renamed_from`, added index rename detection via `IndexDef.extra["stateql.renamed_from"]`, introduced `diff::rename` helpers (`resolve_rename_match`, index metadata decoding, and rename-equivalence normalization), and added RED->GREEN coverage for table/column/index rename plus no-annotation fallback behavior.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff/rename.rs`, `crates/core/tests/rename_detection_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test rename_detection_test`: PASS (4 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (58 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Normalize index definitions by stripping rename metadata before equality comparison so index rename annotations do not force false add/drop diffs.
  - Gotchas encountered: `IndexDef` has no dedicated `renamed_from` field yet, so explicit index rename intent must currently be carried through `extra` metadata (`stateql.renamed_from`) until parser attachment adds first-class support.
---
## 2026-02-22 - task-17: Implement Name Matching with `schema_search_path`
- What was implemented: Added `diff::name_resolution` helpers and wired `DiffEngine` table/index matching to resolve qualified/unqualified names using `DiffConfig.schema_search_path` while preserving strict exact-key matching as the first path and rename matching as the later fallback. Added dedicated RED->GREEN tests for match/mismatch behavior and first-match ordering.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff/name_resolution.rs`, `crates/core/tests/schema_search_path_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test schema_search_path_test`: PASS (4 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (62 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Centralize qualified/unqualified fallback matching in a small resolver module and call it from each object-key path (table/index) to keep compare-phase logic readable and consistent.
  - Gotchas encountered: To keep ADR-0014 “first search path match wins” deterministic, resolution should construct candidate keys in search-path order instead of scanning map iteration order.
---
## 2026-02-22 - task-18: Implement `enable_drop` Suppression Diagnostics
- What was implemented: Added a dedicated `diff::enable_drop` module with `DiffDiagnostics`/`SkippedOpDiagnostic` payloads and a constant `SkippedOpKind` suppression table; extended `DiffEngine` with `diff_with_diagnostics(...)` that preserves existing diff behavior while returning skipped destructive operations as diagnostics when `enable_drop=false`.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff/enable_drop.rs`, `crates/core/src/lib.rs`, `crates/core/tests/enable_drop_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test enable_drop_test`: PASS (2 passed, 0 failed).
  - `enable_drop_test` verifies suppressed op count and diagnostics payload kind/content for `DropTable` and `Revoke`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (64 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: A two-pass diff (`enable_drop=false` emitted ops plus `enable_drop=true` reference ops) lets diagnostics capture suppressed destructive operations without changing existing compare-path behavior.
  - Gotchas encountered: `Privilege` in current IR uses `operations: Vec<PrivilegeOp>` and `on`/`with_grant_option` fields, so suppression tests for `Revoke` must construct that exact shape.
---
## 2026-02-22 - task-19: Implement Constraint Modification Pairing
- What was implemented: Added a dedicated constraint-pairing helper module and integrated it into check-constraint diffing so named CHECK constraint body changes emit `DropCheck + AddCheck` as a pair even when `enable_drop=false`, while unpaired destructive drops remain suppressed.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff/constraint_pairing.rs`, `crates/core/tests/constraint_pairing_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test constraint_pairing_test`: PASS (2 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (66 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keeping pairing logic in a small key-matching helper avoids scattering special-case `enable_drop` exceptions across compare code paths.
  - Gotchas encountered: The existing compare path only pairs named CHECK constraints today; unnamed fallback pairing from the design note will require broader constraint matching when unnamed CHECK diff support is expanded.
---
## 2026-02-22 - task-20: Implement Privilege Set-Difference Semantics
- What was implemented: Added dedicated privilege diff logic with `(on, grantee)` matching and canonical operation set-difference (`diff_privilege_ops`), emitting minimal `Grant/Revoke` ops for added/removed operations plus `with_grant_option` deltas; integrated privilege comparison into remaining-object diff flow and removed the previous privilege fail-fast path.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/privilege.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff/compare_remaining.rs`, `crates/core/tests/privilege_diff_test.rs`, `crates/core/tests/diff_remaining_objects_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test privilege_diff_test`: PASS (4 passed, 0 failed).
  - `cargo +nightly-2026-02-20 fmt --all`: PASS.
  - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
  - `cargo nextest run --workspace`: PASS (70 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep privilege-op comparison isolated in a canonical set helper so emit logic can separately compose operation diffs and grant-option-only diffs without depending on input ordering.
  - Gotchas encountered: For `with_grant_option` downgrade, shared operations must emit `Revoke` with `with_grant_option=true` (grant-option revoke semantics) while removed operations should still revoke the privilege itself (`with_grant_option=false`).
---
## 2026-02-22 - task-21: Implement View Rebuild Closure Expansion
- What was implemented: Added dependent-view rebuild closure expansion for changed views, including transitive dependency traversal and deterministic drop/create ordering; refactored view dependency graph construction into a dedicated `diff/view_rebuild.rs` module and wired view diff comparison to use it.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare_remaining.rs`, `crates/core/src/diff/view_rebuild.rs`, `crates/core/tests/view_rebuild_scope_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test view_rebuild_scope_test`: PASS (2 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (72 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep view rebuild planning as a dedicated closure planner that consumes current/desired view graphs and returns ordered keys, so compare logic stays focused on op emission.
  - Gotchas encountered: Dependency extraction from raw view SQL must resolve unqualified relation names using the source view schema first; otherwise unchanged dependents can be missed when names are schema-qualified in IR.
---
## 2026-02-22 - task-22: Implement Diff Ordering Priorities
- What was implemented: Added deterministic diff ordering in a new root `ordering` module with explicit priority (`1..30`) and table sub-priority (`22a..22i`) enums; wired `DiffEngine::resolve_and_order` to use the sorter; added dependency-aware ordering for `CreateTable` (FK graph) and `CreateView` (view reference graph) with declaration-order fallback; added Task 22 RED->GREEN contract tests and updated one pre-existing search-path test expectation to reflect global drop-before-create ordering.
- Files changed: `crates/core/src/ordering.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff.rs`, `crates/core/src/lib.rs`, `crates/core/tests/diff_ordering_test.rs`, `crates/core/tests/schema_search_path_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test diff_ordering_test`: PASS (6 passed, 0 failed).
  - `diff_ordering_test` fixture verifies `DESIGN.md` priority `1..30` coverage (no missing lines) and enforces `22a..22i`, FK/view dependency ordering, and declaration-order fallback: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (78 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep priority-aware ordering as a pure sorter over `Vec<DiffOp>` so compare logic remains focused on diff emission while ordering-specific evolution stays isolated.
  - Gotchas encountered: Introducing global ordering can invalidate older tests that asserted incidental emission order; behavior-focused tests should assert deterministic ordering contract or membership unless sequence is part of the spec.
---
## 2026-02-22 - task-22b: Implement Dedicated DDL Planner Module (`plan.rs`)
- What was implemented: Added a dedicated planning module (`crates/core/src/plan.rs`) with `DdlPlanner`, `DdlPlan`, and `build_ddl_plan(...)`; moved planner-facing ordering access from `diff` to `plan`; updated `DiffEngine::resolve_and_order` to delegate through the planner so ordering remains centralized in Task 22 sorter behavior.
- Files changed: `crates/core/src/plan.rs`, `crates/core/src/lib.rs`, `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/tests/ddl_plan_builder_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test ddl_plan_builder_test`: PASS (2 passed, 0 failed).
  - Planner API is exported via `stateql_core` (`DdlPlanner`, `DdlPlan`, `build_ddl_plan`, `sort_diff_ops`) and validated by integration tests importing root exports: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (80 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep planner construction API as a thin boundary over deterministic sorting so orchestrator/executor tasks can consume a stable plan type without re-embedding ordering rules.
  - Gotchas encountered: Re-exporting `sort_diff_ops` from both `diff` and `plan` causes duplicate root imports; planner boundary migration needs a single export source (`plan`).
---
## 2026-02-22 - task-23: Implement Circular FK Fallback
- What was implemented: Added dedicated circular-FK graph handling and wired it into `DiffEngine` so create-side FK cycles are split into `AddForeignKey` ops after `CreateTable`, drop-side FK cycles emit `DropForeignKey` before `DropTable`, and self-referential FKs are excluded from cycle fallback.
- Files changed: `crates/core/src/diff.rs`, `crates/core/src/diff/compare.rs`, `crates/core/src/diff/cycle.rs`, `crates/core/tests/circular_fk_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test circular_fk_test`: PASS (3 passed, 0 failed).
  - `circular_fk_test` explicitly verifies CREATE fallback, DROP fallback, and self-FK exclusion: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (83 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Preserve declaration-order semantics for create/drop table passes by iterating table buckets in source order and keeping cycle-specific graph logic isolated from general ordering priorities.
  - Gotchas encountered: Drop-side cycle fallback can only produce `DropForeignKey` for named constraints (`ForeignKey.name: Some(...)`), so unnamed FKs remain drop-by-table behavior.
---
## 2026-02-22 - task-24: Implement Executor Transaction Grouping
- What was implemented: Added a new `Executor` in core with `execute_plan` that groups consecutive transactional `Statement::Sql` items into a single transaction and commits once per group, plus helper-split transaction state flow (`execute_next_group` / `execute_transactional_group`) and a RED->GREEN grouping test using the shared in-memory fake adapter.
- Files changed: `crates/core/src/executor.rs`, `crates/core/src/lib.rs`, `crates/core/tests/executor_grouping_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test executor_grouping_test`: PASS (1 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (84 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Segment-based execution (contiguous transactional run -> one transaction) keeps grouping logic deterministic and avoids long-lived mutable-borrow state inside the executor loop.
  - Gotchas encountered: Keeping a `Transaction<'_>` in an outer mutable state holder can complicate adapter borrow lifetimes; executing one transactional run at a time keeps borrow scopes simple.
---
## 2026-02-22 - task-25: Implement Non-Transactional Boundary Handling
- What was implemented: Added executor support for `transactional:false` statements by executing them directly on the adapter between transactional groups, introduced `flush_tx_if_open(...)` for shared commit handling, and added RED->GREEN coverage for `T,T,N,T,T` boundary semantics and execution ordering.
- Files changed: `crates/core/src/executor.rs`, `crates/core/tests/executor_non_transactional_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test executor_non_transactional_test`: PASS (1 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (85 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep `Executor` boundary behavior as `transactional` segment execution + direct non-transactional dispatch, so commit-before / begin-after semantics are guaranteed by segment transitions without long-lived transaction state.
  - Gotchas encountered: `Statement::BatchBoundary` remains fail-fast in Task 25 by design; changing it here would violate task sequencing and overlap Task 26 semantics.
---
## 2026-02-22 - task-26: Implement BatchBoundary No-Commit Semantics
- What was implemented: Added Task 26 `BatchBoundary` execution semantics in `Executor` by treating `Statement::BatchBoundary` as a synchronization no-op (no SQL emission, no commit trigger) both in top-level dispatch and while scanning transactional groups, so `T,T,B,T` remains one transaction.
- Files changed: `crates/core/src/executor.rs`, `crates/core/tests/executor_batchboundary_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test executor_batchboundary_test`: PASS (1 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (86 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Batch-boundary behavior is safest when modeled as cursor advancement in the executor loop, avoiding any hidden transaction lifecycle side effects.
  - Gotchas encountered: Handling `BatchBoundary` only in top-level dispatch is insufficient because transactional-run scanners can still split runs at boundaries and inadvertently introduce extra commits.
---
## 2026-02-22 - task-27: Propagate Execution Context into `ExecutionError`
- What was implemented: Added `ExecutionError::StatementFailed.statement_context` and an `ExecutionError::statement_failed(...)` builder, then updated `Executor` to map adapter/transaction failures into statement-scoped execution errors with statement index, SQL text, executed statement count, inherited source location, and propagated `Statement::Sql.context`.
- Files changed: `crates/core/src/error.rs`, `crates/core/src/executor.rs`, `crates/core/tests/execution_error_context_test.rs`, `crates/core/tests/error_types_test.rs`, `crates/core/tests/error_wrap_test.rs`, `crates/core/tests/support/fake_adapter.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-mysql/src/lib.rs`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-mssql/src/lib.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test execution_error_context_test`: PASS (1 passed, 0 failed).
  - Failure-path contract verified in test: `statement_index=1`, failed SQL text matches, `executed_statements=1`, and `statement_context` is propagated from `Statement::Sql.context`.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (87 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep execution error mapping centralized in `Executor` so statement metadata is attached consistently for begin/execute/commit failure paths.
  - Gotchas encountered: Adding full `StatementContext` directly to `ExecutionError` triggered `clippy::result_large_err`; boxing that payload (`Option<Box<StatementContext>>`) preserves typed diagnostics while keeping workspace lints green.
---
## 2026-02-22 - task-28: Implement Renderer with Dialect Separator
- What was implemented: Added core `Renderer` with `Renderer::new(&dyn Dialect)` and `render(&[Statement]) -> String`; SQL statements are rendered line-by-line and `Statement::BatchBoundary` is converted to the dialect separator with newline normalization (e.g., `GO` -> `GO\n`).
- Files changed: `crates/core/src/renderer.rs`, `crates/core/src/lib.rs`, `crates/core/tests/renderer_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test renderer_test`: PASS (1 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (88 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep renderer output deterministic by making newline handling explicit for both SQL lines and dialect separators.
  - Gotchas encountered: Dialect separators may already include a trailing newline; renderer-level normalization avoids duplicate blank lines in dry-run output.
---
## 2026-02-22 - task-29: Implement Orchestrator `--dry-run` and `--apply`
- What was implemented: Added core orchestrator flow with `Mode::{Apply,DryRun}` and a single `run(...)` entrypoint that performs parse -> normalize -> diff -> generate, injects `DiffConfig` from runtime inputs (`enable_drop`, adapter `schema_search_path`, dialect `equivalence_policy`), executes statements for apply via `Executor`, and returns rendered SQL for dry-run with `-- Skipped:` diagnostics lines sourced from diff suppression diagnostics.
- Files changed: `crates/core/src/orchestrator.rs`, `crates/core/src/lib.rs`, `crates/core/tests/orchestrator_apply_dryrun_test.rs`, `crates/core/tests/orchestrator_diffconfig_wiring_test.rs`, `crates/core/tests/support/fake_dialect.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test orchestrator_apply_dryrun_test`: PASS (2 passed, 0 failed).
  - `cargo nextest run -p stateql-core --test orchestrator_diffconfig_wiring_test`: PASS (3 passed, 0 failed).
  - `orchestrator_apply_dryrun_test` stability vs dialect implementation progress: PASS (tests use only `tests/support/fake_dialect.rs` and do not depend on `stateql-dialect-*` crates).
  - `orchestrator_diffconfig_wiring_test` explicit wiring checks: PASS (`enable_drop`, `schema_search_path`, and `equivalence_policy` injection validated; dry-run includes `-- Skipped:` output when destructive ops are suppressed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (93 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep orchestrator policy injection independent from `DiffConfig` ownership using a delegating policy wrapper (`&'static dyn EquivalencePolicy` -> `Arc<dyn EquivalencePolicy>`) so dialect-owned policy behavior is preserved without widening diff API lifetimes.
  - Gotchas encountered: Shared integration-test support modules are compiled per test target; helper methods used only by sibling tests must be guarded (`#[allow(dead_code)]`) to keep workspace-wide `-D warnings` green.
---
## 2026-02-22 - task-30: Implement Orchestrator `--export`
- What was implemented: Added `Mode::Export` and `OrchestratorOutput::ExportSql(String)` to orchestrator dispatch, implemented the dedicated export route (`export_schema -> parse -> normalize -> to_sql`) with one-line-per-object rendering, and added RED->GREEN integration coverage that verifies `to_sql` is called while diff/generate/execute paths stay unused.
- Files changed: `crates/core/src/orchestrator.rs`, `crates/core/tests/orchestrator_export_test.rs`, `crates/core/tests/support/fake_dialect.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test orchestrator_export_test`: PASS (1 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (94 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Export behavior is easiest to keep correct by sharing only `parse_and_normalize` with other modes and isolating all mode-specific work behind a single `match`.
  - Gotchas encountered: To make `to_sql` invocation testable without coupling to output text conventions, the shared fake dialect needs explicit `to_sql` call recording in its internal state.
---
## 2026-02-22 - task-30b: Verify `--export` Round-Trip Idempotency
- What was implemented: Added round-trip idempotency coverage for export mode with a new `orchestrator_export_roundtrip_test`, introduced an orchestrator helper (`export_roundtrip_matches`) that re-renders exported SQL through `parse -> normalize -> to_sql` for equality checks, and refactored export fixtures into a shared support module used by both export test files.
- Files changed: `crates/core/src/orchestrator.rs`, `crates/core/tests/orchestrator_export_test.rs`, `crates/core/tests/orchestrator_export_roundtrip_test.rs`, `crates/core/tests/support/orchestrator_export_fixture.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test orchestrator_export_roundtrip_test`: PASS (2 passed, 0 failed).
  - `cargo nextest run -p stateql-core --test orchestrator_export_test --test orchestrator_export_roundtrip_test`: PASS (3 passed, 0 failed).
  - 2-pass export invariant (`first_export == second_export`) verified in `export_is_idempotent_across_two_passes`: PASS.
  - Task note recorded: dialect-specific round-trip deltas remain covered by dialect tasks (`task-33a/33b/33c/34b/34c/34d`) and their adapter tests.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (96 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Shared integration-test fixtures in `crates/core/tests/support/` avoid drift between behavior tests and contract tests when export paths evolve.
  - Gotchas encountered: In round-trip tests using a fixture dialect, the second pass must register a parse fixture for the first export text, otherwise the parse stage fails before idempotency can be checked.
---
## 2026-02-22 - task-31: PostgreSQL Parse Pipeline with `pg_query`
- What was implemented: Added a PostgreSQL parser pipeline (`AnnotationExtractor::extract -> pg_query parse -> statement conversion -> attach_annotations`) and replaced the dialect parse stub with fail-fast conversion wiring. Implemented initial `CREATE TABLE` conversion (table/column basics, default expression capture, extra metadata keys) and explicit unsupported-statement failures.
- Files changed: `Cargo.lock`, `crates/dialect-postgres/Cargo.toml`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-postgres/src/parser.rs`, `crates/dialect-postgres/src/extra_keys.rs`, `crates/dialect-postgres/tests/parser_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-dialect-postgres --test parser_test`: PASS (2 passed, 0 failed).
  - `parser_test` validates `source_sql` and `source_location.line` on `ParseError::StatementConversion`; `column` remains `None` when unavailable: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (98 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Use parser-span-based metadata plus a single error-wrapper helper to keep statement-level parse diagnostics deterministic across all conversion errors.
  - Gotchas encountered: In this sandbox, Cargo cannot write to the default home cache; running with `CARGO_HOME=/tmp/cargo` avoids permission failures during dependency resolution/build.
---
## 2026-02-22 - task-32: PostgreSQL Full DDL Generator + Unsupported-Op Contract
- What was implemented: Added a full PostgreSQL DDL generator module (`generator.rs`) and wired `PostgresDialect::generate_ddl` to it; implemented SQL emission for the complete current `DiffOp` surface, centralized unsupported payload failures via `unsupported_diff_op`, and added conservative `DROP VIEW + CREATE VIEW` to `CREATE OR REPLACE VIEW` optimization with compatibility checks.
- Files changed: `crates/dialect-postgres/src/generator.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-postgres/tests/generator_contract_test.rs`, `crates/dialect-postgres/tests/generator_supported_ops_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-dialect-postgres --test generator_contract_test`: PASS (3 passed, 0 failed).
  - `cargo nextest run -p stateql-dialect-postgres --test generator_supported_ops_test`: PASS (3 passed, 0 failed).
  - `generator_contract_test` consumes Task 13 fixture coverage (`all_diffop_variants()`) via `#[path = "../../core/tests/support/diffop_fixtures.rs"]` and classifies all variants exhaustively: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (104 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keeping generator dispatch and unsupported construction centralized makes it straightforward to enforce fail-fast behavior for malformed variant payloads while still supporting an exhaustive `DiffOp` match.
  - Gotchas encountered: Reusing `crates/core/tests/support/diffop_fixtures.rs` cross-crate in dialect tests needs a local `#[allow(dead_code)]` on the included module to keep workspace `-D warnings` clean.
---
## 2026-02-22 - task-33a: PostgreSQL Normalizer
- What was implemented: Added a dedicated PostgreSQL normalizer module with split helpers (`types`, `expr`, `sequence`, `partition`), wired `PostgresDialect::normalize` to it, and integrated a schema-level normalize pass into the parser pipeline so parsed PostgreSQL objects are canonicalized immediately after annotation attachment. Implemented custom type alias/case normalization, serial/identity sequence representation normalization, and partition child folding (`CREATE TABLE ... PARTITION OF ...`) into parent `PartitionElement` entries.
- Files changed: `crates/dialect-postgres/src/normalize.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-postgres/src/parser.rs`, `crates/dialect-postgres/src/extra_keys.rs`, `crates/dialect-postgres/tests/normalize_representation_rules_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-dialect-postgres --test normalize_representation_rules_test`: PASS (3 passed, 0 failed).
  - Partition child -> `PartitionElement` folding verified in `folds_partition_children_into_parent_partition_elements`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (107 passed, 0 failed).
- **Learnings:**
  - Patterns discovered: Keep partition-child lineage in parser metadata (`postgres.partition_parent_*`) and perform fold/removal in a single schema-level normalizer pass so parent partition state stays deterministic and child tables never leak into diff input.
  - Gotchas encountered: `pg_query` cannot deparse partition key/bound sub-nodes as top-level SQL; robust conversion must read protobuf node variants (`PartitionElem`, `AConst`, `ColumnRef`) directly instead of relying on `deparse()`.
---
## 2026-02-22 - task-33b: PostgreSQL `to_sql` + Adapter + Export Queries
- What was implemented: Added PostgreSQL adapter runtime (`connect`, `export_schema`, `schema_search_path`, `server_version`, `execute`, `begin`) on a single synchronous connection, migrated catalog SQL constants into `export_queries.rs`, implemented canonical `to_sql` rendering through generator-backed create-op mapping (including partition child re-emission), and replaced dialect stubs with production wiring plus surface tests for round-trip stability and version gating.
- Files changed: `crates/dialect-postgres/src/adapter.rs`, `crates/dialect-postgres/src/export_queries.rs`, `crates/dialect-postgres/src/to_sql.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-postgres/Cargo.toml`, `crates/dialect-postgres/tests/adapter_export_schema_test.rs`, `crates/dialect-postgres/tests/dialect_surface_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-dialect-postgres --test dialect_surface_test`: PASS (3 passed, 0 failed).
  - `cargo nextest run -p stateql-dialect-postgres --test adapter_export_schema_test`: PASS (2 passed, 0 failed, 1 skipped).
  - `cargo nextest run -p stateql-dialect-postgres --test adapter_export_schema_test --run-ignored ignored-only`: PASS (1 passed, 0 failed, 2 skipped).
  - `rg -n "pub async fn" crates/dialect-postgres/src`: PASS (0 hit).
  - `dialect_surface_test` explicit `<13` rejection check: PASS (`connect_rejects_postgres_versions_below_13`).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (112 passed, 0 failed, 1 skipped).
- **Learnings:**
  - Patterns discovered: Keep adapter query text and schema export assembly separated (`export_queries.rs` + row-decoder/render helpers) so catalog coverage changes do not leak into connection/version/search-path handling.
  - Gotchas encountered: `ExecutionError` display omits inner source messages, so tests that validate fail-fast details should assert on `source.to_string()` instead of top-level `Error::to_string()`.
---
## 2026-02-22 - task-33c: PostgreSQL EquivalencePolicy Implementation
- What was implemented: Added dialect-specific PostgreSQL `EquivalencePolicy` with deterministic residual expression canonicalization for casted integer literals (`'0'::integer`), redundant outer parentheses, and whitespace-only differences; wired `PostgresDialect::equivalence_policy()` to the new static policy; added integration tests that verify strict-vs-policy behavior through core diff and policy symmetry/stability contracts.
- Files changed: `crates/dialect-postgres/src/equivalence.rs`, `crates/dialect-postgres/src/lib.rs`, `crates/dialect-postgres/tests/equivalence_policy_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-dialect-postgres --test equivalence_policy_test`: PASS (3 passed, 0 failed).
  - false diff regression cases (cast/literal, redundant parens, whitespace residuals) no longer reproduce via core `DiffEngine` when PostgreSQL policy is injected: PASS (`strict_diff_reports_*` tests assert strict config emits diffs and policy config emits none).
  - symmetry / stability contract is explicitly verified in `postgres_policy_contract_is_symmetric_and_stable_and_keeps_structural_mismatch_strict`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (115 passed, 0 failed, 1 skipped).
- **Learnings:**
  - Patterns discovered: For residual expression equivalence, canonicalize text with quote-aware whitespace folding and balanced outer-paren stripping before narrow cast-literal handling; keep policy pure/deterministic and leave structural normalization to dialect normalizers.
  - Gotchas encountered: Running quality gates concurrently causes transient cargo build-lock waits (`Blocking waiting for file lock on build directory`); the runs still passed once locks were released.
---
## 2026-02-22 - task-34: Add MySQL/SQLite/MSSQL Parse Pipelines (`sqlparser-rs`)
- What was implemented: Added fail-fast parser pipelines for MySQL/SQLite/MSSQL (`AnnotationExtractor::extract -> sqlparser parse -> statement conversion -> attach_annotations`), introduced per-dialect parser and `extra_keys` modules, replaced parse stubs in all three dialect `lib.rs` files, and added integration tests for unsupported-statement context plus orphan-annotation fail-fast behavior.
- Files changed: `Cargo.lock`, `crates/dialect-mysql/Cargo.toml`, `crates/dialect-sqlite/Cargo.toml`, `crates/dialect-mssql/Cargo.toml`, `crates/dialect-mysql/src/lib.rs`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-mssql/src/lib.rs`, `crates/dialect-mysql/src/parser.rs`, `crates/dialect-sqlite/src/parser.rs`, `crates/dialect-mssql/src/parser.rs`, `crates/dialect-mysql/src/extra_keys.rs`, `crates/dialect-sqlite/src/extra_keys.rs`, `crates/dialect-mssql/src/extra_keys.rs`, `crates/dialect-mysql/tests/parser_test.rs`, `crates/dialect-sqlite/tests/parser_test.rs`, `crates/dialect-mssql/tests/parser_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-dialect-mysql --test parser_test`: PASS (3 passed, 0 failed).
  - `cargo nextest run -p stateql-dialect-sqlite --test parser_test`: PASS (3 passed, 0 failed).
  - `cargo nextest run -p stateql-dialect-mssql --test parser_test`: PASS (3 passed, 0 failed).
  - All three parser test suites explicitly verify `statement_index` / `source_sql` / `source_location.line` retention on unsupported statements and orphan annotation fail-fast behavior: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (124 passed, 0 failed, 1 skipped).
- **Learnings:**
  - Patterns discovered: In `sqlparser-rs` dialects, keep conversion helpers dialect-local but standardize parse-error wrapping/signature (`statement_conversion_error`) so fail-fast metadata remains uniform across backends.
  - Gotchas encountered: `sqlparser-rs` does not provide stable per-statement source offsets for this pipeline, so a local quote/comment-aware statement splitter is needed to populate deterministic `SourceLocation.line` values.
---
## 2026-02-22 - task-34b: SQLite Full Normalize / to_sql / Adapter
- What was implemented: Replaced SQLite dialect stubs with production `connect/export_schema/schema_search_path/server_version/normalize/to_sql` wiring; added a synchronous `rusqlite` adapter with `3.35+` preflight version gating and deterministic schema export for table/view/index/trigger; added SQLite normalize and renderer modules with explicit unsupported-variant errors; and added parser source-SQL hints (`sqlite.source_sql`) so parse-normalize-to_sql export round-trips stay stable while parser conversion remains table-focused.
- Files changed: `Cargo.lock`, `crates/dialect-sqlite/Cargo.toml`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-sqlite/src/adapter.rs`, `crates/dialect-sqlite/src/export_queries.rs`, `crates/dialect-sqlite/src/normalize.rs`, `crates/dialect-sqlite/src/to_sql.rs`, `crates/dialect-sqlite/src/extra_keys.rs`, `crates/dialect-sqlite/src/parser.rs`, `crates/dialect-sqlite/tests/adapter_export_schema_test.rs`, `crates/dialect-sqlite/tests/dialect_surface_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-dialect-sqlite --test dialect_surface_test`: PASS (3 passed, 0 failed).
  - `cargo nextest run -p stateql-dialect-sqlite --test adapter_export_schema_test`: PASS (2 passed, 0 failed).
  - `rg -n "pub async fn" crates/dialect-sqlite/src`: PASS (0 hit).
  - `dialect_surface_test` explicit `<3.35` rejection verification: PASS (`connect_rejects_sqlite_versions_below_3_35`).
  - `dialect_surface_test` supported variant (`Table/View/Index/Trigger`) valid SQL + unsupported variant explicit `Error` coverage: PASS (`to_sql_supports_sqlite_variants_and_rejects_unsupported_variants`).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (129 passed, 0 failed, 1 skipped).
- **Learnings:**
  - Patterns discovered: For SQLite task staging, keep export query constants in `export_queries.rs` and keep adapter/table SQL rendering deterministic with explicit ordering and statement terminators.
  - Gotchas encountered: `Dialect::to_sql` can be called on parse outputs before full structured conversion coverage exists, so source SQL hints are needed to avoid invalid empty-table renders during intermediate milestones.
---
## 2026-02-22 - task-34c: MySQL Full Normalize / to_sql / Adapter
- What was implemented: Replaced MySQL dialect stubs with production `connect/export_schema/schema_search_path/server_version/normalize/to_sql` wiring; added a synchronous `mysql`-crate adapter with `8.0+` preflight version gating and deterministic schema export for tables/views/triggers; added MySQL normalize and renderer modules with explicit unsupported-variant errors; and added parser source-SQL/partition hints (`mysql.source_sql`, `mysql.partition_sql`) so parse-normalize-to_sql export round-trips stay stable while parser conversion remains table-first.
- Files changed: `Cargo.lock`, `crates/dialect-mysql/Cargo.toml`, `crates/dialect-mysql/src/lib.rs`, `crates/dialect-mysql/src/adapter.rs`, `crates/dialect-mysql/src/export_queries.rs`, `crates/dialect-mysql/src/normalize.rs`, `crates/dialect-mysql/src/to_sql.rs`, `crates/dialect-mysql/src/parser.rs`, `crates/dialect-mysql/src/extra_keys.rs`, `crates/dialect-mysql/tests/dialect_surface_test.rs`, `crates/dialect-mysql/tests/adapter_export_schema_test.rs`, `crates/dialect-mysql/tests/normalize_lower_case_table_names_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-dialect-mysql --test dialect_surface_test`: PASS (3 passed, 0 failed).
  - `cargo nextest run -p stateql-dialect-mysql --test adapter_export_schema_test`: PASS (1 passed, 0 failed, 1 skipped).
  - `cargo nextest run -p stateql-dialect-mysql --test normalize_lower_case_table_names_test`: PASS (1 passed, 0 failed).
  - `cargo nextest run -p stateql-dialect-mysql --test adapter_export_schema_test --run-ignored ignored-only`: PASS (1 passed, 0 failed, 1 skipped).
  - `rg -n "pub async fn" crates/dialect-mysql/src`: PASS (0 hit).
  - `dialect_surface_test` explicit `<8.0` rejection verification: PASS (`connect_rejects_mysql_versions_below_8_0`).
  - `dialect_surface_test` supported variant (`Table/View/Index/Trigger/Function`) valid SQL + unsupported variant explicit `Error` coverage: PASS (`to_sql_supports_mysql_variants_and_rejects_unsupported_variants`).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (134 passed, 0 failed, 2 skipped).
- **Learnings:**
  - Patterns discovered: Keep MySQL adapter query text in `export_queries.rs` and pair parser-side `mysql.source_sql` hints with `to_sql` fallback to preserve export round-trips before full structured parser coverage.
  - Gotchas encountered: `clippy::absurd_extreme_comparisons` fires if a `u16` minor-version check compares against `0`; use a major-version gate for `8.0+` while keeping the user-facing error message explicit.
---
## 2026-02-22 - task-34d: MSSQL Full Normalize / to_sql / Adapter
- What was implemented: Replaced MSSQL dialect stubs with production wiring for `connect/export_schema/schema_search_path/server_version/normalize/to_sql`; added `adapter.rs` with synchronous adapter boundary (live `tiberius` backend + override-backed export path for deterministic tests), added MSSQL export query constants, added MSSQL normalizer and SQL renderer with supported-vs-unsupported `SchemaObject` handling, and updated parser preconversion hints to persist `mssql.source_sql` plus clustered/identity flags for round-trip stability.
- Files changed: `Cargo.lock`, `crates/dialect-mssql/Cargo.toml`, `crates/dialect-mssql/src/lib.rs`, `crates/dialect-mssql/src/extra_keys.rs`, `crates/dialect-mssql/src/parser.rs`, `crates/dialect-mssql/src/export_queries.rs`, `crates/dialect-mssql/src/adapter.rs`, `crates/dialect-mssql/src/normalize.rs`, `crates/dialect-mssql/src/to_sql.rs`, `crates/dialect-mssql/tests/dialect_surface_test.rs`, `crates/dialect-mssql/tests/adapter_export_schema_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mssql --test dialect_surface_test`: PASS (3 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mssql --test adapter_export_schema_test`: PASS (2 passed, 0 failed, 1 skipped).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mssql --test adapter_export_schema_test --run-ignored ignored-only`: PASS (1 passed, 0 failed, 2 skipped).
  - `rg -n "pub async fn" crates/dialect-mssql/src`: PASS (0 hit).
  - `dialect_surface_test` explicit `2019`-minimum reject coverage: PASS (`connect_rejects_sql_server_versions_below_2019`).
  - `dialect_surface_test` supported variant (`Table/View/Index/Trigger/Function/Schema`) valid SQL + unsupported variant explicit `Error` coverage: PASS (`to_sql_supports_mssql_variants_and_rejects_unsupported_variants`).
  - Quality gates:
    - `CARGO_HOME=/tmp/cargo cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo nextest run --workspace`: PASS (139 passed, 0 failed, 3 skipped).
- **Learnings:**
  - Patterns discovered: Keep MSSQL adapter internals async-capable (`tiberius`) but enforce the public adapter contract as synchronous by blocking within a private runtime and returning only core `Result`/typed errors.
  - Gotchas encountered: `clippy::large_enum_variant` triggered for mixed live/override adapter backends; boxing the live backend state preserves ergonomics while satisfying workspace `-D warnings`.
---
## 2026-02-22 - task-34e: Add MySQL/SQLite/MSSQL Equivalence Policy Coverage
- What was implemented: Added explicit custom equivalence policies for MySQL/SQLite/MSSQL and wired each dialect `equivalence_policy()` to absorb residual `Expr::Raw` false diffs (integer cast alias, redundant outer parentheses, whitespace-only differences) while keeping structural mismatches strict; added RED->GREEN dialect coverage tests and documented per-dialect policy boundaries in the new matrix document.
- Files changed: `crates/dialect-mysql/src/lib.rs`, `crates/dialect-mysql/src/equivalence.rs`, `crates/dialect-mysql/tests/equivalence_policy_test.rs`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-sqlite/src/equivalence.rs`, `crates/dialect-sqlite/tests/equivalence_policy_test.rs`, `crates/dialect-mssql/src/lib.rs`, `crates/dialect-mssql/src/equivalence.rs`, `crates/dialect-mssql/tests/equivalence_policy_test.rs`, `docs/2026-02-21-equivalence-policy-matrix.md`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mysql --test equivalence_policy_test`: PASS (3 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-sqlite --test equivalence_policy_test`: PASS (3 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mssql --test equivalence_policy_test`: PASS (3 passed, 0 failed).
  - `docs/2026-02-21-equivalence-policy-matrix.md` added with explicit MySQL/SQLite/MSSQL policy differences and scope boundaries: PASS.
  - Quality gates:
    - `CARGO_HOME=/tmp/cargo cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo nextest run --workspace`: PASS (148 passed, 0 failed, 3 skipped).
- **Learnings:**
  - Patterns discovered: Keep non-PostgreSQL equivalence policies narrowly scoped to residual raw-expression canonicalization and preserve strict behavior for structural expression mismatches.
  - Gotchas encountered: In this sandbox, cargo operations are more reliable with `CARGO_HOME=/tmp/cargo` to avoid cache permission issues.
---
## 2026-02-22 - task-35: SQLite Full Generator (Rebuild + Unsupported-Op Contract)
- What was implemented: Added a SQLite `generate_ddl` implementation in `generator.rs` with simple ALTER coverage (`AddColumn` append, `RenameTable`, `RenameColumn`), per-table rebuild batching for structure-changing ops (`AlterColumn`, `DropColumn`, FK/check/exclusion/PK diffs), and explicit fail-fast unsupported-op behavior with variant-tagged `GenerateError`. Rebuild output now emits transactional SQL statements with `StatementContext::SqliteTableRebuild` for all six rebuild steps.
- Files changed: `crates/dialect-sqlite/src/generator.rs`, `crates/dialect-sqlite/src/lib.rs`, `crates/dialect-sqlite/tests/rebuild_generator_test.rs`, `crates/dialect-sqlite/tests/generator_contract_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-sqlite --test rebuild_generator_test`: PASS (3 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-sqlite --test generator_contract_test`: PASS (2 passed, 0 failed).
  - `generator_contract_test` exhaustively classifies all `DiffOp` variants via `all_diffop_variants()` and fails on support-contract drift: PASS.
  - Quality gates:
    - `CARGO_HOME=/tmp/cargo cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo nextest run --workspace`: PASS (153 passed, 0 failed, 3 skipped).
- **Learnings:**
  - Patterns discovered: Rebuild-step context should be attached to every emitted SQL statement (including no-op rebuild tail steps) so executor error propagation can reliably pinpoint failing rebuild phases.
  - Gotchas encountered: SQLite rebuild generation currently depends on diff payload richness; when full target table shape is unavailable in a batch, the safest fallback is shadow-table creation via `CREATE TABLE ... AS SELECT ... WHERE 0` plus fail-fast handling for unsupported SQL surface.
---
## 2026-02-22 - task-36: MySQL Full Generator (CHANGE COLUMN / AUTO_INCREMENT / AFTER / Partitioning)
- What was implemented: Added MySQL `generate_ddl` implementation in `generator.rs` with per-table batching, merged `AlterColumn` -> single `CHANGE COLUMN` emission, AUTO_INCREMENT two-phase ordering (PK ops before AUTO_INCREMENT change), `ADD COLUMN ... FIRST/AFTER` rendering, partition add/drop SQL emission, and `DropView + CreateView` -> `CREATE OR REPLACE VIEW` optimization when names match; wired dialect `lib.rs` to the generator and shared `to_sql` render helpers for consistent SQL formatting.
- Files changed: `crates/dialect-mysql/src/generator.rs`, `crates/dialect-mysql/src/lib.rs`, `crates/dialect-mysql/src/to_sql.rs`, `crates/dialect-mysql/tests/change_column_merge_test.rs`, `crates/dialect-mysql/tests/auto_increment_ordering_test.rs`, `crates/dialect-mysql/tests/column_position_after_test.rs`, `crates/dialect-mysql/tests/partition_generator_test.rs`, `crates/dialect-mysql/tests/generator_contract_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mysql --test change_column_merge_test`: PASS (1 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mysql --test auto_increment_ordering_test`: PASS (1 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mysql --test column_position_after_test`: PASS (1 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mysql --test partition_generator_test`: PASS (2 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mysql --test generator_contract_test`: PASS (2 passed, 0 failed).
  - `generator_contract_test` exhaustively classifies all `DiffOp` variants via `all_diffop_variants()` and validates supported-vs-unsupported behavior: PASS.
  - Quality gates:
    - `CARGO_HOME=/tmp/cargo cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo nextest run --workspace`: PASS (160 passed, 0 failed, 3 skipped).
- **Learnings:**
  - Patterns discovered: MySQL generator correctness is more stable when unsupported-shape errors from renderer helpers are remapped to variant-tagged `UnsupportedDiffOp` errors at the generator boundary, so exhaustive support-contract tests stay aligned with `DiffOp` classification.
  - Gotchas encountered: `to_sql` helper failures can leak internal diff-op names (`CreateTableUnsupportedShape`) unless explicitly normalized in generator error mapping.
---
## 2026-02-22 - task-37: MSSQL Full Generator (`BatchBoundary` / `sp_rename` / `IDENTITY`)
- What was implemented: Added a production MSSQL `generate_ddl` pipeline in `generator.rs` with explicit op dispatch, variant-tagged unsupported-op errors, deterministic `Statement::BatchBoundary` injection between emitted SQL statements, and `sp_rename` builders for table/column/index renames; wired `MssqlDialect::generate_ddl()` to the new generator; and added RED->GREEN coverage for create+rename batch behavior, identity/clustered/NFR rendering, and exhaustive `DiffOp` support-contract classification.
- Files changed: `crates/dialect-mssql/src/generator.rs`, `crates/dialect-mssql/src/lib.rs`, `crates/dialect-mssql/tests/mssql_generator_test.rs`, `crates/dialect-mssql/tests/identity_and_clustered_test.rs`, `crates/dialect-mssql/tests/generator_contract_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mssql --test mssql_generator_test`: PASS (1 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mssql --test identity_and_clustered_test`: PASS (1 passed, 0 failed).
  - `CARGO_HOME=/tmp/cargo cargo nextest run -p stateql-dialect-mssql --test generator_contract_test`: PASS (2 passed, 0 failed).
  - `generator_contract_test` exhaustively classifies all `DiffOp` variants via `all_diffop_variants()` and validates supported-vs-unsupported behavior: PASS.
  - Quality gates:
    - `CARGO_HOME=/tmp/cargo cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `CARGO_HOME=/tmp/cargo cargo nextest run --workspace`: PASS (164 passed, 0 failed, 3 skipped).
- **Learnings:**
  - Patterns discovered: Keep MSSQL rename SQL generation in dedicated helpers that build `sp_rename` targets from `QualifiedName`/`Ident` instead of ad-hoc string formatting in each match arm.
  - Gotchas encountered: Parallel `cargo` invocations in this sandbox can pause on build/cache locks (`Blocking waiting for file lock on build directory`), so verification runs should be serialized to reduce transient wait noise.
---
## 2026-02-22 - task-38: Add YAML `TestCase` Schema with Defaults
- What was implemented: Added `testkit` YAML testcase schema/loader with `serde` defaults, preserving `error`, `enable_drop` tri-state, `min_version`, `max_version`, and `flavor`; added parse-error mapping to core `Error` (`ParseError::StatementConversion`) with YAML location metadata; exported loader/types from `stateql_testkit`; and added RED->GREEN coverage tests for omitted `offline` default plus field retention contracts.
- Files changed: `crates/testkit/src/yaml_runner.rs`, `crates/testkit/src/lib.rs`, `crates/testkit/Cargo.toml`, `crates/testkit/tests/testcase_schema_test.rs`, `Cargo.lock`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-testkit --test testcase_schema_test`: PASS (3 passed, 0 failed).
  - `testcase_schema_test` verifies `error` string retention, `enable_drop` tri-state (`None/Some(true)/Some(false)`), and `min_version`/`max_version`/`flavor` retention: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (167 passed, 0 failed, 3 skipped).
- **Learnings:**
  - Patterns discovered: Keep YAML testcase parsing at the top-level map boundary (`name -> TestCase`) and preserve tri-state runtime knobs as `Option` in schema parsing instead of resolving defaults too early.
  - Gotchas encountered: `serde_yaml` surfaces line/column through `Error::location()`, which should be converted into `stateql_core::SourceLocation` immediately so downstream runner diagnostics remain fail-fast and consistent.
---
## 2026-02-22 - task-38b: Implement YAML `flavor` Matching Semantics
- What was implemented: Added `TestResult`, pure `matches_flavor`, and shared flavor expectation handling in `yaml_runner` that enforces positive/negative flavor rules for both `run_offline_test` and `run_online_test`; mismatch execution now follows sqldef-style validation (`failure => skip`, `success => fail annotation`) while matched flavor keeps normal pass/fail behavior.
- Files changed: `crates/testkit/src/yaml_runner.rs`, `crates/testkit/src/lib.rs`, `crates/testkit/tests/yaml_flavor_filter_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-testkit --test yaml_flavor_filter_test`: PASS (3 passed, 0 failed).
  - `yaml_flavor_filter_test` verifies both positive (`flavor: mysql`) and negative (`flavor: !tidb`) matching plus mismatch behavior for both `run_offline_test` and `run_online_test`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (170 passed, 0 failed, 3 skipped).
- **Learnings:**
  - Patterns discovered: Centralizing flavor mismatch handling in one wrapper keeps online/offline runner semantics aligned while preserving a pure matcher for focused tests.
  - Gotchas encountered: Keeping new runner APIs private to `yaml_runner` triggers dead_code warnings under workspace `-D warnings`; re-exporting through `stateql_testkit` avoids lint regressions.
---
## 2026-02-22 - task-39: Add Offline Runner
- What was implemented: Implemented offline YAML runner execution in `yaml_runner` as direct `parse -> normalize -> diff -> generate_ddl` flow (no adapter/orchestrator dependency), added expected `up/down` SQL assertions, and enforced `error` expectation matching while wiring `enable_drop` into `DiffConfig` with `None => false` resolution.
- Files changed: `crates/testkit/src/yaml_runner.rs`, `crates/testkit/tests/offline_runner_test.rs`, `crates/testkit/tests/support/offline_fake_dialect.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-testkit --test offline_runner_test`: PASS (3 passed, 0 failed).
  - `rg -n "Orchestrator" crates/testkit/src/yaml_runner.rs crates/testkit/tests/offline_runner_test.rs`: PASS (0 matches).
  - `offline_runner_test` verifies `error` expectation handling and `enable_drop` propagation for `None/Some(false)/Some(true)`: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (173 passed, 0 failed, 3 skipped).
- **Learnings:**
  - Patterns discovered: Keep expected SQL assertion logic in one helper (`assert_expected_sql`) and compare trimmed rendered SQL because renderer appends trailing newlines.
  - Gotchas encountered: RED tests for runner behavior are easiest to stabilize with a fake dialect that records `generate_ddl` batches, so `enable_drop` wiring can be validated via emitted diff ops.
---
## 2026-02-22 - task-40: Add Online Runner
- What was implemented: Implemented the YAML online runner with DESIGN §6.2 8-step execution (`apply current`, current idempotency check, forward diff/assert/apply, desired idempotency check, reverse diff/assert/apply, final idempotency check) using live adapter exports, core `Executor`, and online-specific version gating (`min_version`/`max_version`) that returns `TestResult::Skipped` when out of range. Added RED->GREEN online runner tests covering fake-adapter call-path/idempotency/error/enable_drop behavior plus ignored container-backed smoke tests for PostgreSQL/MySQL/MSSQL.
- Files changed: `crates/testkit/src/yaml_runner.rs`, `crates/testkit/tests/online_runner_test.rs`, `crates/testkit/Cargo.toml`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-testkit --test online_runner_test`: PASS (5 passed, 0 failed, 3 skipped).
  - `cargo nextest run -p stateql-testkit --test online_runner_test --run-ignored ignored-only`: PASS (3 passed, 0 failed, 5 skipped; env-gated early-return behavior validated in this sandbox).
  - `online_runner_test` verifies online `error` expectation matching and `enable_drop` reflection against live exported schema state: PASS.
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (178 passed, 0 failed, 6 skipped).
- **Learnings:**
  - Patterns discovered: Keep online runner idempotency assertions separate from expected `up`/`down` SQL assertions so live-state drift is caught even when direction expectations are omitted.
  - Gotchas encountered: Reusing support modules across integration test binaries can trigger `dead_code` warnings under workspace `-D warnings`; either split support modules by use case or intentionally exercise shared helpers in each binary.
---
## 2026-02-22 - task-41: Add Safety Regressions S1-S5
- What was implemented: Added a dedicated cross-module safety regression suite `crates/core/tests/safety_s1_s5_test.rs` covering S1 (unknown DDL fail-fast with no diff/execute side effects), S2 (orphan rename annotation fail-fast before drop/create planning), S3 (non-transactional boundary failure semantics), S4 (`BatchBoundary` no-commit rollback semantics), and S5 (missing index owner fail-fast).
- Files changed: `crates/core/tests/safety_s1_s5_test.rs`, `ralph-loop/.commit-msg`, `ralph-loop/prd.json`, `ralph-loop/progress.txt`.
- DoD verification results:
  - `cargo nextest run -p stateql-core --test safety_s1_s5_test`: PASS (5 passed, 0 failed).
  - Quality gates:
    - `cargo +nightly-2026-02-20 fmt --all`: PASS.
    - `cargo clippy --workspace --all-targets -- -D warnings`: PASS.
    - `cargo nextest run --workspace`: PASS (183 passed, 0 failed, 6 skipped).
- **Learnings:**
  - Patterns discovered: Keep safety regressions assertion-heavy on both error variants and side effects (`generated_ops`, `executed_sql`, transaction counters) so “must not silently drop/commit” guarantees are directly pinned.
  - Gotchas encountered: RED-phase expectations were already satisfied by current implementation for these scenarios, so Task 41 completed as regression lock-in without production code fixes.
---
